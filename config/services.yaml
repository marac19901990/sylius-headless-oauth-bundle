services:
    _defaults:
        autowire: true
        autoconfigure: true

    # Credential Validator
    Marac\SyliusHeadlessOAuthBundle\Validator\CredentialValidator: ~

    # Provider Field Mapper
    Marac\SyliusHeadlessOAuthBundle\Provider\ProviderFieldMapper: ~

    # HTTP Client for OAuth requests
    Marac\SyliusHeadlessOAuthBundle\Http\OAuthHttpClient:
        class: GuzzleHttp\Client
        arguments:
            - timeout: 10
              http_errors: false

    # Security: Redirect URI Validator
    Marac\SyliusHeadlessOAuthBundle\Security\RedirectUriValidator:
        arguments:
            $allowedUris: '%sylius_headless_oauth.security.allowed_redirect_uris%'

    # Security: OAuth Security Logger
    Marac\SyliusHeadlessOAuthBundle\Security\OAuthSecurityLogger:
        arguments:
            $logger: '@?logger'
        tags:
            - { name: 'monolog.logger', channel: 'oauth_security' }

    # Security: Apple JWKS Verifier
    Marac\SyliusHeadlessOAuthBundle\Security\AppleJwksVerifier:
        arguments:
            $httpClient: '@Marac\SyliusHeadlessOAuthBundle\Http\OAuthHttpClient'
            $cache: '@?cache.app'
            $clientId: '%sylius_headless_oauth.providers.apple.client_id%'

    # Apple Client Secret Generator
    Marac\SyliusHeadlessOAuthBundle\Provider\Apple\AppleClientSecretGenerator:
        arguments:
            $clientId: '%sylius_headless_oauth.providers.apple.client_id%'
            $teamId: '%sylius_headless_oauth.providers.apple.team_id%'
            $keyId: '%sylius_headless_oauth.providers.apple.key_id%'
            $privateKeyPath: '%sylius_headless_oauth.providers.apple.private_key_path%'

    # Google OAuth Provider
    Marac\SyliusHeadlessOAuthBundle\Provider\GoogleProvider:
        arguments:
            $httpClient: '@Marac\SyliusHeadlessOAuthBundle\Http\OAuthHttpClient'
            $clientId: '%sylius_headless_oauth.providers.google.client_id%'
            $clientSecret: '%sylius_headless_oauth.providers.google.client_secret%'
            $enabled: '%sylius_headless_oauth.providers.google.enabled%'
        tags:
            - { name: 'sylius_headless_oauth.provider' }

    # Apple OAuth Provider
    Marac\SyliusHeadlessOAuthBundle\Provider\AppleProvider:
        arguments:
            $httpClient: '@Marac\SyliusHeadlessOAuthBundle\Http\OAuthHttpClient'
            $clientSecretGenerator: '@Marac\SyliusHeadlessOAuthBundle\Provider\Apple\AppleClientSecretGenerator'
            $clientId: '%sylius_headless_oauth.providers.apple.client_id%'
            $enabled: '%sylius_headless_oauth.providers.apple.enabled%'
            $jwksVerifier: '@Marac\SyliusHeadlessOAuthBundle\Security\AppleJwksVerifier'
            $verifyJwt: '%sylius_headless_oauth.security.verify_apple_jwt%'
            $securityLogger: '@Marac\SyliusHeadlessOAuthBundle\Security\OAuthSecurityLogger'
        tags:
            - { name: 'sylius_headless_oauth.provider' }

    # User Resolver
    Marac\SyliusHeadlessOAuthBundle\Resolver\UserResolver:
        arguments:
            $customerRepository: '@sylius.repository.customer'
            $customerFactory: '@sylius.factory.customer'
            $shopUserFactory: '@sylius.factory.shop_user'
            $entityManager: '@doctrine.orm.entity_manager'
            $eventDispatcher: '@event_dispatcher'

    # OAuth Processor (API Platform)
    Marac\SyliusHeadlessOAuthBundle\Processor\OAuthProcessor:
        arguments:
            $providers: !tagged_iterator 'sylius_headless_oauth.provider'
            $userResolver: '@Marac\SyliusHeadlessOAuthBundle\Resolver\UserResolver'
            $jwtManager: '@lexik_jwt_authentication.jwt_manager'
            $redirectUriValidator: '@Marac\SyliusHeadlessOAuthBundle\Security\RedirectUriValidator'
            $securityLogger: '@Marac\SyliusHeadlessOAuthBundle\Security\OAuthSecurityLogger'
            $eventDispatcher: '@event_dispatcher'
        tags:
            - { name: 'api_platform.state_processor' }

    # OAuth Refresh Processor (API Platform)
    Marac\SyliusHeadlessOAuthBundle\Processor\OAuthRefreshProcessor:
        arguments:
            $providers: !tagged_iterator 'sylius_headless_oauth.provider'
            $userResolver: '@Marac\SyliusHeadlessOAuthBundle\Resolver\UserResolver'
            $jwtManager: '@lexik_jwt_authentication.jwt_manager'
            $securityLogger: '@Marac\SyliusHeadlessOAuthBundle\Security\OAuthSecurityLogger'
        tags:
            - { name: 'api_platform.state_processor' }

    # Provider Health Checker
    Marac\SyliusHeadlessOAuthBundle\Checker\ProviderHealthChecker:
        arguments:
            $providers: !tagged_iterator 'sylius_headless_oauth.provider'

    # Check Providers Command
    Marac\SyliusHeadlessOAuthBundle\Command\CheckProvidersCommand:
        arguments:
            $healthChecker: '@Marac\SyliusHeadlessOAuthBundle\Checker\ProviderHealthChecker'
        tags:
            - { name: 'console.command' }
